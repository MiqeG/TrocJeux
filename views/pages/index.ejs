<% include header %>
<script src="https://momentjs.com/downloads/moment-with-locales.js"> </script>

<div class="ui  asd " style="margin-bottom:10%;">
  <form class="ui form simulaform" action="">


  <h1><i class=" big teal calendar alternate outline icon"> </i> Nos Annonces</h1>
  <div class="container" style="width:100%;"><div class="right floated"><select class="ui dropdown amountdropdown">
    <option value="20">20</option>
    <option value="50">50</option>
    <option value="100">100</option>
  </select><select class="ui dropdown catdropdown">
      <option value="Toutes">Toutes</option>
       <% categories.forEach(element => { %>
      <option value="<%= element %>"><%= element %></option>
      <% }); %>
  </select></div>
  <table id="adtable" class="ui teal table" style="max-width:945px;background-color:transparent">
    <tbody>
    </tbody>
  </table>
  <br>
  <table>
    <tbody>
      <tr class="ui grid adcontainer" id="refresherDIv">

      </tr>
    </tbody>

  </table>
  <div class="field" id="pagdiv"></div>
  <div class="ui pagination menu" id="mainpagepagination">
     
    </div>
</div>
</form>
</div>


<% include footer %>

<script>

  function clickFunk(event) {
    $('.ui.basic.modal.ImageModal').modal('show')
    $('#ModalImage').attr('src', $(event).attr('src'))
  }

  function bigcards(entry) {
    $(entry).transition({
      animation: 'pulse',
      interval: 10000,
      duration: 500,
      allowRepeats: false,
      useFailSafe: true
    })
  }

  $('.ZoomImage').on('error',function(){
   console.log('ok')
  })
moment.locale('fr')
  ajaxads(1, 'Toutes', 20)
    function ajaxads(pagination, categorie, amount) {
     $('.simulaform').addClass('loading')
      $.ajax({
        url: '/adapi',
        type: 'POST',
        dataType: 'json',
        data: { pagination: pagination, categorie: categorie, amount: amount },
        success: function (data) {
          $('.amountdropdown').dropdown('set selected', data.useramount);
          $('.catdropdown').dropdown('set selected', data.categorie);
          $('#refresherDIv').empty()
            $('.simulaform').removeClass('loading')
           console.log(data)
          data.annonces.forEach(element => {
            let finalstring = ''
            let defaultText=$('.amountdropdown').dropdown('get value')
          
            element.Categories.forEach(cat => {
              let str = ` <a class="" data-cat="${cat}" onclick="ajaxads(1,'${cat}',${defaultText})">${cat}</a>,`
              finalstring += str
            })
            let date=moment(element.DatePublication, "YYYYMMDD").fromNow()
            let link = '/?a=' + element._id
            let mainImageSrc = 'pregistered/' + element.User_Id + '/' + element._id + '/' + element.UserImages[0]
            let output = 
            `<td class="centered" ><div style="height:500px;width:220px"><div style="height:420px;" class="ui  card" data-html="<div class='header'>User Rating</div>
              <div class='content'><div class='ui star rating'><i class='active icon'></i><i class='active icon'></i><i class='active icon'></i><i class='active icon'></i>
                <i class='active icon'></i></div></div>">
  <div class="image">
    <img src="${mainImageSrc}" style="height:200px;" class="ZoomImage" onclick="clickFunk(this)" onerror="this.src='assets/img/error.gif'">
  </div>
  <div class="content">
    <div class="header" style="overflow-y:auto;height:60px;"> ${element.Titre}</div>
    <div class="description">
        <div style="color:purple;">  ${element.NomUitilisateur}</div>
    </div>
    <div class="description">
        <div style="color:teal;">${date}</div>
    </div>
    <div class="description">
      ${element.CodePostal},${element.Ville}
    </div>
    <div class="description">
      ${finalstring}
    </div>
  </div>
  <div class="ui two bottom attached buttons">
    <div class="ui button cardbutton">
      <i class="user icon"></i>
      Profil
    </div>
    <div class="ui primary button cardbutton" onhover="hoverFunk(this)" onclick="window.location.href='${link}'">
      <i class="calendar alternate outline icon"></i>
      DÃ©tails
    </div>
  </div>
</div>

  
   </div></td>`
            $('.adcontainer').append(output)
            
          });
          $('.button').mouseenter(function () {
                $(this).transition('pulse')
                    ;
            })
            
          console.log(data)
         
          $('#mainpagepagination').empty()
          for (let index = 1; index <= data.totaladamount+1; index++) {
            if(index>10||(index==1&&data.totaladamount>10)){
              $('#mainpagepagination').prepend(`<div class="active item" id="minusser" onclick="minusfunction($('.disabled.item.identifier'))">-</div>`)
              break;
            }
           else if(index>10||(index==data.totaladamount+1&&data.totaladamount>10)){
              $('#mainpagepagination').append(`<div class="active item" id="plusser" onclick="plusfunction($('.disabled.item.identifier'))">+</div>`)
              break;
            }
           else if(data.userpagination==index){
              $('#mainpagepagination').append(`<a class="disabled item identifier inc" onclick="ajaxads($(this).text(),$('.catdropdown').dropdown('get value'),$('.amountdropdown').dropdown('get value'))">${index}</a>`)
            }
            else if(index<=data.totaladamount){
              $('#mainpagepagination').append(`<a class="item identifier inc" onclick="ajaxads($(this).text(),$('.catdropdown').dropdown('get value'),$('.amountdropdown').dropdown('get value'))">${index}</a>`)
            }
            else{
              break
            }
            
          }
        },
        error: function (err) {
          $('.simulaform').removeClass('loading')
        //  $('.amountdropdown').dropdown('set selected', data.useramount);
          //$('.catdropdown').dropdown('set selected', data.categorie);
          console.log(err.responseJSON.message)

        }
      })
    }
   console.log($('.amountdropdown').dropdown('get value'))
   $('#plusser').click(function(){
     $('.')
   })
 $('.catdropdown').dropdown({onChange: function() {ajaxads(1,$('.catdropdown').dropdown('get value'),$('.amountdropdown').dropdown('get value'))}})
  
    $('.amountdropdown').dropdown({ onChange: function() {ajaxads(1,$('.catdropdown').dropdown('get value'),$('.amountdropdown').dropdown('get value'))}});
</script>
